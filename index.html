    <script>
        // === „Ç∑„Çπ„ÉÜ„É†Â§âÊï∞ ===
        let currentMode = null;
        let currentCategory = 0;
        let quizPool = [], wordBank = [], currentQuiz = null;

        // === „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ===
        function startApp(mode) {
            currentMode = mode;
            document.getElementById('mode-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'flex';
            document.getElementById('btn-home').style.display = 'block';

            // UIÂàá„ÇäÊõø„Åà
            if(mode === 'review') {
                document.getElementById('search-section').style.display = 'flex';
                document.getElementById('gallery-list').style.display = 'grid';
                document.getElementById('quiz-container').style.display = 'none';
            } else {
                document.getElementById('search-section').style.display = 'none';
                document.getElementById('gallery-list').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'flex';
            }
            selectCategory(0);
        }

        function goHome() {
            currentMode = null;
            document.getElementById('mode-screen').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('btn-home').style.display = 'none';
            document.getElementById('gallery-list').innerHTML = '';
            document.getElementById('quiz-container').style.display = 'none';
            closeModalDirect();
        }

        // === „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ===
        function toggleMethod() {
            const box = document.getElementById('method-box');
            box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        }
        function changeLanguage(lang) {
            // (ÁúÅÁï•ÂèØËÉΩ„Åß„Åô„ÅåÂÆâÂÖ®„ÅÆ„Åü„ÇÅÊÆã„Åó„Åæ„Åô)
            if(document.getElementById('btn-en')) document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            // ...Ë®ÄË™ûÂàáÊõø„É≠„Ç∏„ÉÉ„ÇØ„ÅØÊó¢Â≠ò„ÅÆ„ÇÇ„ÅÆ„ÇíÂà©Áî®...
            // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å™ÂÜçÊèèÁîª„Éà„É™„Ç¨„Éº„ÅÆ„Åø
            if(currentMode) selectCategory(currentCategoryIndex);
        }
        function handleEnter(e) { if(e.key === 'Enter') performSearch(); }
        
        // ‚òÖÂçòË™û„Åã„ÇâÊó•Êú¨Ë™û(„Ç´„ÉÉ„Ç≥Êõ∏„Åç)„ÇíÂèñ„ÇäÈô§„Åè„ÇØ„É™„Éº„Éã„É≥„Ç∞Èñ¢Êï∞
        function cleanVocab(str) {
            // "apple („Çä„Çì„Åî)" ‚Üí "apple" „Å´Â§âÊèõ
            return str.replace(/\s*\(.*?\)/g, '').trim();
        }

        // === „Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏Êäû ===
        function selectCategory(cat) {
            currentCategoryIndex = cat;
            document.getElementById('img-search-input').value = '';

            document.querySelectorAll('.genre-btn').forEach(btn => {
                const onclickVal = btn.getAttribute('onclick');
                let btnArg = onclickVal.match(/selectCategory\(([^)]+)\)/)[1].replace(/['"]/g, '');
                if (!isNaN(btnArg)) btnArg = parseInt(btnArg, 10);
                if(btnArg === cat) btn.classList.add('active'); else btn.classList.remove('active');
            });

            const list = window.galleryData.filter(item => {
                if (cat === 'cnn') return item.imageFile.toLowerCase().includes('cnn');
                const match = item.imageFile.match(/(\d+)/);
                const num = match ? parseInt(match[1], 10) : -1;
                return Math.floor(num / 100) === cat;
            });

            list.sort((a, b) => {
                const getNum = s => (s.imageFile.match(/(\d+)/) || [0,0])[1];
                return getNum(a) - getNum(b);
            });

            if(currentMode === 'review') renderGalleryList(list);
            else initQuiz(list);
        }

        // === Review Mode (Êó¢Â≠òÊ©üËÉΩ) ===
        function performSearch() {
            const inputVal = document.getElementById('img-search-input').value;
            if (!inputVal) return;
            const targetNum = parseInt(inputVal, 10);
            if (isNaN(targetNum)) return;
            document.querySelectorAll('.genre-btn').forEach(btn => btn.classList.remove('active'));
            const list = window.galleryData.filter(item => {
                const match = item.imageFile.match(/(\d+)/);
                const num = match ? parseInt(match[1], 10) : -1;
                return num === targetNum;
            });
            renderGalleryList(list);
        }

        function renderGalleryList(list) {
            const container = document.getElementById('gallery-list');
            container.innerHTML = '';
            if (list.length === 0) {
                container.style.display = 'block'; 
                container.innerHTML = `<p style="text-align:center; color:#999; padding:40px;">No matching image found.</p>`;
                return;
            }
            container.style.display = 'grid';
            list.forEach((data) => {
                const match = data.imageFile.match(/(\d+)/);
                const fileNum = match ? match[1] : data.imageFile.split('.')[0]; 
                const thumb = document.createElement('div');
                thumb.className = 'gallery-thumb';
                thumb.onclick = () => openLessonModal(data);
                thumb.innerHTML = `<div class="thumb-img-wrapper"><img src="${data.imageFile}" class="thumb-img" loading="lazy"></div><div class="thumb-info">No. ${fileNum}</div>`;
                container.appendChild(thumb);
            });
        }

        function openLessonModal(data) {
            const modal = document.getElementById('lesson-modal');
            const body = document.getElementById('modal-body');
            const match = data.imageFile.match(/(\d+)/);
            const fileNum = match ? match[1] : data.imageFile.split('.')[0]; 
            const cardID = `card-${fileNum}`;

            const article = document.createElement('article');
            article.className = 'photo-card';
            // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆHTMLÊßãÁØâ (Êó¢Â≠ò„ÅÆ„Éá„Ç∂„Ç§„É≥„ÇíÁ∂≠ÊåÅ)
            article.innerHTML = `
                <div class="card-header"><span class="card-number">No. ${fileNum}</span><button class="toggle-frame-btn" onclick="toggleLocalFrames('${cardID}', this)">Show Frames</button></div>
                <div class="image-wrapper" id="${cardID}-wrapper"><img src="${data.imageFile}" class="main-image"></div>
                <div class="desc-box" id="${cardID}-desc">
                    <span class="desc-title">Title</span>
                    <div class="eng-row"><div class="eng-text"></div><button class="speak-btn main-speak">üîä</button></div>
                    <div class="jp-text"></div>
                    <div class="learning-grid">
                        <div class="learn-item"><h4>Vocab <button class="mini-speak-btn vocab-speak">üîä</button></h4><ul class="l-vocab"></ul></div>
                        <div class="learn-item"><h4>Idioms <button class="mini-speak-btn idiom-speak">üîä</button></h4><ul class="l-idiom"></ul></div>
                        <div class="learn-item"><h4>Synonyms <button class="mini-speak-btn synonym-speak">üîä</button></h4><ul class="l-synonym"></ul></div>
                        <div class="learn-item"><h4>Grammar</h4><div class="l-grammar" style="font-size:0.9rem; color:#444;"></div></div>
                    </div>
                </div>
            `;
            const wrapper = article.querySelector('.image-wrapper');
            if(data.spots) data.spots.forEach(spot => {
                const div = document.createElement('div');
                div.className = 'hotspot';
                Object.assign(div.style, { top: spot.top, left: spot.left, width: spot.width, height: spot.height, borderColor: spot.color });
                div.onclick = (e) => { e.stopPropagation(); updateDescription(cardID, spot); };
                wrapper.appendChild(div);
            });
            body.innerHTML = '';
            body.appendChild(article);
            modal.style.display = 'flex';
        }

        function closeModal(e) { if (e.target.id === 'lesson-modal') closeModalDirect(); }
        function closeModalDirect() {
            document.getElementById('lesson-modal').style.display = 'none';
            document.getElementById('modal-body').innerHTML = '';
        }

        function toggleLocalFrames(cardID, btn) {
            const wrapper = document.getElementById(`${cardID}-wrapper`);
            const spots = wrapper.querySelectorAll('.hotspot');
            if (spots.length === 0) return;
            let isHidden = (spots[0].style.display === 'none' || spots[0].style.display === '');
            spots.forEach(s => s.style.display = isHidden ? 'block' : 'none');
            btn.textContent = isHidden ? "Hide Frames" : "Show Frames";
            btn.classList.toggle('active', isHidden);
            if(!isHidden) document.getElementById(`${cardID}-desc`).style.display = 'none'; 
        }

        function updateDescription(cardID, data) {
            const box = document.getElementById(`${cardID}-desc`);
            box.style.display = 'block'; box.style.borderTopColor = data.color;
            box.querySelector('.desc-title').textContent = data.title;
            box.querySelector('.desc-title').style.color = data.color;
            box.querySelector('.eng-text').textContent = data.eng;
            box.querySelector('.jp-text').textContent = data.jp;
            box.querySelector('.l-grammar').textContent = data.grammar || "";
            
            const fillList = (cls, items) => {
                const ul = box.querySelector(cls); ul.innerHTML = '';
                if(items) items.forEach(txt => { const li = document.createElement('li'); li.textContent = txt; ul.appendChild(li); });
            };
            fillList('.l-vocab', data.vocab); fillList('.l-idiom', data.idioms); fillList('.l-synonym', data.synonyms);
            
            const setupSpeak = (sel, txt) => {
                const btn = box.querySelector(sel); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
                if(txt && txt.length > 0) { newBtn.style.display = 'inline-block'; newBtn.onclick = () => speakText(txt); } else { newBtn.style.display = 'none'; }
            };
            const clean = (arr) => (!arr || arr.length===0)?"":arr.map(i=>i.replace(/\s*\(.*?\)/g,'')).join(", ");
            setupSpeak('.main-speak', data.eng);
            setupSpeak('.vocab-speak', clean(data.vocab));
            setupSpeak('.idiom-speak', clean(data.idioms));
            setupSpeak('.synonym-speak', clean(data.synonyms));
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; speechSynthesis.speak(u);
            }
        }

        // ============================================
        // 5. Quiz Mode (VocabÂÑ™ÂÖà & Êó•Êú¨Ë™ûÂâäÈô§Áâà)
        // ============================================
        function initQuiz(list) {
            document.getElementById('gallery-list').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'flex';
            
            // 1. ÈÅ∏ÊäûËÇ¢Áî®„Éê„É≥„ÇØ„Çí‰ΩúÊàêÔºàÊó•Êú¨Ë™ûÂâäÈô§„Åó„Å¶ÁôªÈå≤Ôºâ
            wordBank = [];
            list.forEach(item => {
                if(item.spots) item.spots.forEach(s => {
                    if (s.vocab && s.vocab.length > 0) {
                        s.vocab.forEach(v => {
                            const cleaned = cleanVocab(v); // ‚òÖ„Åì„Åì„ÅßÊó•Êú¨Ë™ûÂâäÈô§
                            if(cleaned.length > 0) wordBank.push(cleaned);
                        });
                    } else {
                        const words = s.eng.replace(/[.,?!"]/g, '').split(/\s+/);
                        words.forEach(w => { if(w.length > 3) wordBank.push(w); });
                    }
                });
            });
            if (wordBank.length === 0) wordBank = ["apple", "pen", "this", "that"]; 

            // 2. „ÇØ„Ç§„Ç∫„Çí‰ΩúÊàê
            quizPool = [];
            list.forEach(item => {
                if(item.spots) item.spots.forEach(spot => {
                    const words = spot.eng.split(' ');
                    let candidates = [];
                    
                    // Vocab„Éû„ÉÉ„ÉÅ„É≥„Ç∞ (Êó•Êú¨Ë™ûÂâäÈô§Âæå„ÅÆÂçòË™û„Å®ÊØîËºÉ)
                    if (spot.vocab && spot.vocab.length > 0) {
                        words.forEach((w, i) => {
                            const cleanW = w.toLowerCase().replace(/[.,?!"]/g, '');
                            const isVocabMatch = spot.vocab.some(v => {
                                const cleanV = cleanVocab(v).toLowerCase(); // ‚òÖÊØîËºÉÊôÇ„ÇÇÊó•Êú¨Ë™ûÂâäÈô§
                                return cleanV.length > 1 && (cleanW.includes(cleanV) || cleanV.includes(cleanW));
                            });
                            if (isVocabMatch) candidates.push(i);
                        });
                    }
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    if (candidates.length === 0) {
                        words.forEach((w, i) => { if(w.replace(/[.,?!"]/g,'').length >= 4) candidates.push(i); });
                    }
                    
                    if(candidates.length > 0) {
                        const targetIdx = candidates[Math.floor(Math.random() * candidates.length)];
                        quizPool.push({
                            img: item.imageFile, spot: spot,
                            fullEng: spot.eng, words: words,
                            ans: words[targetIdx].replace(/[.,?!"]/g, ''), idx: targetIdx
                        });
                    }
                });
            });

            if(quizPool.length === 0) {
                document.getElementById('q-sentence').textContent = "No quiz data available.";
                return;
            }
            quizPool.sort(() => Math.random() - 0.5);
            nextQuiz();
        }

        function nextQuiz() {
            if(quizPool.length === 0) return;
            const idx = Math.floor(Math.random() * quizPool.length);
            currentQuiz = quizPool[idx];
            const q = currentQuiz;

            document.getElementById('q-controls').style.visibility = 'hidden';
            document.getElementById('q-options').innerHTML = '';
            document.getElementById('q-main-img').src = q.img;
            
            const wrap = document.getElementById('quiz-img-wrapper');
            Array.from(wrap.children).forEach(c => { if(c.tagName !== 'IMG') wrap.removeChild(c); });
            
            const spotDiv = document.createElement('div');
            spotDiv.className = 'target-spot';
            Object.assign(spotDiv.style, { top:q.spot.top, left:q.spot.left, width:q.spot.width, height:q.spot.height });
            wrap.appendChild(spotDiv);

            document.getElementById('q-jp-hint').textContent = q.spot.jp;
            
            let html = "";
            q.words.forEach((w, i) => {
                if(i === q.idx) {
                    const punc = w.match(/[.,?!"]/) ? w.match(/[.,?!"]/)[0] : "";
                    html += `<span class="blank">______</span>${punc} `;
                } else html += w + " ";
            });
            document.getElementById('q-sentence').innerHTML = html;

            let choices = new Set([q.ans]);
            let limit = 0;
            while(choices.size < 4 && limit < 100) {
                const w = wordBank[Math.floor(Math.random() * wordBank.length)];
                if(w && w.toLowerCase() !== q.ans.toLowerCase()) choices.add(w);
                limit++;
            }
            Array.from(choices).sort(()=>Math.random()-0.5).forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = choice;
                btn.onclick = () => checkAns(btn, choice);
                document.getElementById('q-options').appendChild(btn);
            });
        }

        function checkAns(btn, val) {
            const correct = currentQuiz.ans;
            document.querySelectorAll('.option-btn').forEach(b => {
                b.style.pointerEvents = 'none';
                if(b.textContent.toLowerCase() === correct.toLowerCase()) b.classList.add('correct');
            });

            const msg = document.getElementById('q-result-msg');
            const blank = document.querySelector('.blank');

            if(val.toLowerCase() === correct.toLowerCase()) {
                msg.textContent = "Correct! üéâ"; msg.style.color = "#27ae60";
                blank.textContent = correct; blank.style.color = "#27ae60"; blank.style.borderBottom = "none";
            } else {
                btn.classList.add('wrong');
                msg.textContent = "Try again!"; msg.style.color = "#e74c3c";
            }
            document.getElementById('q-controls').style.visibility = 'visible';
        }
    </script>
